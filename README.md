## Кластеризация минимумов рельефа (Streamlit)

Интерактивное приложение на Streamlit для анализа 3D‑точек рельефа, обнаружения локальных минимумов, вычисления геометрических признаков, кластеризации минимумов и экспорта результатов (CSV, изображения и PDF‑отчёт).

### Возможности
- **Загрузка CSV** со столбцами `X, Y, Z` (без учёта регистра)
- **Автопредложение масштаба** через медиану расстояния до ближайшего соседа
- **Геометрические признаки**: глубина, оценка/счёт бассейна, градиент, кривизны, ориентация
- **Поиск локальных минимумов** по радиусу или k‑ближайшим
- **Кластеризация**: KMeans, DBSCAN, Agglomerative, GMM (с выбором признаков)
- **Визуализации**: 2D тепловая карта (matplotlib) и интерактивная 3D поверхность (Plotly)
- **Водораздел (опция)** для более точной площади бассейнов
- **Экспорт**: CSV минимумов, PDF‑отчёт, ZIP (CSV + изображения + параметры)
- **Киллер‑фича: автоподбор по силуэту** — автоматический перебор нескольких алгоритмов и параметров с выбором лучшего результата

### Требования
- Python 3.10+
- Зависимости перечислены в `requirements.txt`:
  - `streamlit`, `pandas`, `numpy`, `scipy`, `scikit-learn`, `scikit-image`, `plotly`, `matplotlib`, `seaborn`, `fpdf`, `kaleido`

### Установка
```bash
# 1) Виртуальное окружение
python3 -m venv .venv
source .venv/bin/activate  # Windows: .venv\\Scripts\\activate

# 2) Зависимости
pip install --upgrade pip
pip install -r requirements.txt
```

### Запуск
```bash
streamlit run app.py
```
Откройте адрес из терминала (обычно `http://localhost:8501`).

### Формат входного CSV
- Файл должен содержать числовые столбцы `X`, `Y`, `Z` (регистр и пробелы в заголовках не важны)
- Загрузчик (`utils.load_and_prepare`) приводит имена к верхнему регистру и отбрасывает нечисловые строки

Минимальный пример (`data.csv`):
```csv
X,Y,Z
0.0,0.0,10.2
0.5,0.0,10.1
0.0,0.5,10.3
0.5,0.5,10.0
```

### Типовой сценарий
1) Загрузите CSV (`X,Y,Z`).
2) В сайдбаре проверьте предложенный масштаб (медиана NN‑расстояния).
3) При необходимости скорректируйте `R`/`R_basin` и нажмите «Рассчитать признаки и минимумы».
4) Выберите алгоритм и признаки, затем «Запустить кластеризацию», или используйте «Автоподбор».
5) Оцените размер кластеров и метрику силуэта.
6) Просмотрите 2D/3D визуализации; при необходимости включите водораздел.
7) Скачайте CSV / PDF / ZIP.

### Элементы управления (сайдбар)
- **Масштаб и признаки**
  - `Множитель R`: радиус соседства \(R = фактор \times median\_NN\)
  - `Множитель R_basin`: радиус для оценки площади бассейна
  - `Минимум соседей (резерв)`: k при разрежённости точки
  - `Доля глубины для бассейна`: порог включения точки в бассейн
  - Кнопка: «Рассчитать признаки и минимумы»
- **Кластеризация**
  - Алгоритмы: `KMeans | DBSCAN | Agglomerative | GMM`
  - Параметры: `k` (для KMeans/Agglomerative/GMM) или `eps`/`min_samples` (для DBSCAN)
  - Выбор признаков: из рассчитанных доступных
  - Кнопка: «Запустить кластеризацию»
- **Автоподбор**
  - Перебор `k` для KMeans/Agglomerative/GMM и `eps` для DBSCAN
  - Выбор лучшего по silhouette score и таблица лидеров
- **Визуализация**
  - Выбор палитр для поверхности и кластеров
  - Опция: «Рассчитать бассейны методом водораздела (точная площадь)»

### Выходные файлы
- **CSV минимумов**: `minima_with_features_clusters.csv`
- **PDF‑отчёт**: параметры, сводная таблица по кластерам, изображения
- **ZIP**: `minima.csv`, изображения (`heatmap.png`, `3d_surface.png`), `params.json`

### Как это работает
- `features.compute_geometric_features`:
  - Радиусные окрестности (`R`), резерв — k‑ближайших
  - Локальная аппроксимация поверхности (квадратичная/линейная), градиент и кривизны
  - Метрики: `depth`, `basin_count`, `basin_area_est`, `mean_grad`, `mean_curvature`, `gauss_curvature`, `orientation`
- `features.find_local_minima`:
  - Проверка строгого минимума по `Z` относительно соседей
- `clustering.*`:
  - Алгоритмы scikit‑learn, признаки предварительно стандартизируются
- `visualization.*`:
  - `grid_surface` на основе `scipy.interpolate.griddata`
  - 2D/3D графики с подсветкой кластеров; опционально водораздел
- `report.build_pdf_report`:
  - Генерация PDF с параметрами, таблицами и картинками

### Структура проекта
```
mipt/
  app.py                # UI Streamlit и оркестровка
  utils.py              # Загрузка/валидация CSV, медиана NN
  features.py           # Признаки и поиск минимумов
  clustering.py         # Кластеризация (KMeans/DBSCAN/Agglomerative/GMM)
  visualization.py      # Сетка, 2D/3D графики, quiver
  eda.py                # Базовый EDA
  report.py             # PDF‑отчёт
  requirements.txt      # Зависимости
  relief_data.csv       # Пример данных (если есть)
  pgoto.jpg             # Изображение (опционально)
```

### Советы и устранение проблем
- **Минимумы не найдены**: увеличьте `R`, проверьте равномерность/качество данных.
- **Медиана NN ≈ 0**: вероятно, дубль точек — удалите дубликаты или внесите небольшой шум.
- **Экспорт изображений Plotly**: требуется `kaleido` (есть в `requirements.txt`). Перезапустите приложение после установки.
- **Водораздел медленный**: уменьшите `grid_res` в `grid_surface` (по умолчанию 200), если меняете код.
- **Ошибка PDF**: проверьте шрифты/размер картинок; попробуйте снова.

### Лицензия
Не указана. Добавьте лицензию, если планируете распространение.


